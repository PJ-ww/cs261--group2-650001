<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ - TU COMPASS</title>

    <link rel="stylesheet" href="admin-style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/images/favicon.png">
</head>
<body>

    <div class="dashboard-container">
        
        <header>
            <i class="fas fa-flag"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
        </header>
        
        <main>
           

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th style="width: 170px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    </tbody>
            </table>
            
            <div class="pagination" id="pagination-wrapper"></div>
        </main>
    </div>

    <div class="bottom-nav">
        <a href="admin-map.html" class="nav-item">
            <i class="fas fa-home"></i><span>Home</span>
        </a>
        <a href="category.html" class="nav-item">
            <i class="fas fa-cog"></i><span>Category</span>
        </a>
        <a href="admin-report.html" class="nav-item active"> <i class="fas fa-flag"></i><span>Admin Report</span>
        </a>
        <a href="/admin/profile_logged_in.html" class="nav-item">
            <i class="fas fa-user"></i><span>Profile</span>
        </a>
    </div>

    <script>
        /* ============================================
           Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Admin Report
        ============================================ */

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        async function loadReports() {
            const tableBody = document.getElementById("report-table-body");
            
            if (!tableBody) {
                console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö <tbody> ‡∏ó‡∏µ‡πà‡∏°‡∏µ id 'report-table-body'");
                return;
            }

            try {
                const response = await fetch("http://localhost:8080/api/reports/admin/all", {
                    method: "GET",
                    credentials: "include"
                });

                if (!response.ok) {
                    tableBody.innerHTML = `<tr class="error-row"><td colspan="6">‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</td></tr>`;
                    return;
                }

                const reports = await response.json();
                
                if (reports.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ --</td></tr>`;
                    return;
                }

                tableBody.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á

                reports.forEach(r => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${r.id}</td>
                        <td>${r.userId}</td>
                        <td>${r.title}</td>
                        <td>${r.message}</td>
                        <td>${r.placeName || "-"}</td>
                        <td class="actions-cell">
                            <select class="report-status-select" data-id="${r.id}">
                                <option value="NEW" ${r.status === "NEW" ? "selected" : ""}>üî¥ ‡πÉ‡∏´‡∏°‡πà</option>
                                <option value="IN_PROGRESS" ${r.status === "IN_PROGRESS" ? "selected" : ""}>üü† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="DONE" ${r.status === "DONE" ? "selected" : ""}>üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
                addSelectListeners();

            } catch (error) {
                console.error("Error fetching reports:", error);
                tableBody.innerHTML = `<tr class="error-row"><td colspan="6">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</td></tr>`;
            }
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        async function updateStatus(id, status) {
            console.log(`Updating ID: ${id} to Status: ${status}`);
            try {
                await fetch(`http://localhost:8080/api/reports/admin/${id}/status?status=${status}`, {
                    method: "PATCH",
                    credentials: "include"
                });
                // (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° feedback ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ß‡πà‡∏≤ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß")
            } catch (error) {
                console.error("Error updating status:", error);
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á <select>
        function addSelectListeners() {
            document.querySelectorAll(".report-status-select").forEach(select => {
                select.addEventListener("change", (e) => {
                    const id = e.target.dataset.id;
                    const status = e.target.value;
                    updateStatus(id, status);
                });
            });
        }

        // 4. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î
        document.addEventListener("DOMContentLoaded", loadReports);

    </script>
    
    <script type="module">
        import { protectPage } from "../authGuard.js";
        protectPage(true);
    </script>
    
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const raw = localStorage.getItem("student_info");
        if (!raw) return;
        try {
            const parsed = JSON.parse(raw);
            const data = parsed.data ? parsed.data : parsed;
            if (data.displayname_en) {
                const firstName = data.displayname_en.split(" ")[0];
                const navLabel = document.querySelector(".bottom-nav .nav-item:last-child span");
                if (navLabel) navLabel.textContent = firstName;
            }
        } catch (err) { console.error("Error reading admin user", err); }
    });
    </script>

</body>
</html>
