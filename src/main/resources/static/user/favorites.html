<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favorite</title>
    <link rel="stylesheet" href="favorites-style.css">
	<link rel="icon" type="image/png" href="/images/favicon.png"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    
    <script type="module">
        import { protectPage } from "/authGuard.js";
        protectPage(); 
    </script>
</head>
<body>

    <header class="header">
        <h1 class="header-title">Favorite</h1>
    </header>

    <div class="container">
		<div id="favorites-list" class="favorites-list">
		    </div>
        
        <p id="empty-message" class="empty-message" style="display:none;">
            คุณยังไม่มีรายการโปรดที่บันทึกไว้
        </p>

    </div>

    <nav class="bottom-nav">
        <a href="map.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="favorites.html" class="nav-item active">
            <i class="fas fa-bookmark"></i>
            <span>Favorites</span>
        </a>
        <a href="profile_logged_in.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script>
		document.addEventListener('DOMContentLoaded', () => {
		    const favoritesList = document.getElementById('favorites-list');
		    const emptyMessage = document.getElementById('empty-message');
		    const API_BASE_URL = '/api/bookmarks'; 
            let currentFavorites = []; 

            const getTargetDetails = (targetId, targetType) => {
		        const found = currentFavorites.find(f => f.targetId == targetId && f.targetType == targetType);
                return found || { name: `รายการ ID ${targetId}` };
		    };

		    const fetchUserFavorites = async () => {
		        try {
		            const response = await fetch(API_BASE_URL, {
		                method: 'GET',
                        credentials: 'include' 
		            });

		            if (response.status === 403) {
                        console.error("User not authenticated, redirecting...");
                        window.location.href = '/login.html'; 
		                return [];
		            }
		            if (!response.ok) throw new Error('Failed to fetch bookmarks');
		            
		            currentFavorites = await response.json(); 
                    return currentFavorites;

		        } catch (error) {
		            console.error("Error fetching favorites:", error);
		            emptyMessage.innerHTML = '❌ เกิดข้อผิดพลาดในการดึงข้อมูล';
		            emptyMessage.style.display = 'block';
		            return [];
		        }
		    };

		    const createFavoriteCard = (location) => {
		        const card = document.createElement('div');
		        card.className = 'favorite-card';
		        card.innerHTML = `
		            <div class="card-image-placeholder">
		                <i class="fas fa-image"></i>
		            </div>
		            <div class="card-content">
		                <div class="card-header">
		                    <h3 class="card-title">${location.name || `ID: ${location.targetId}`}</h3>
		                    <i class="fas fa-bookmark card-delete-icon" data-target-id="${location.targetId}" data-target-type="${location.targetType}"></i> 
		                </div>
		                <div class="card-actions">
		                    <button class="map-btn" data-target-id="${location.targetId}" data-name="${location.name}">ดูแผนที่</button>
		                    <button class="remove-btn" data-target-id="${location.targetId}" data-target-type="${location.targetType}">ลบ</button>
		                </div>
		            </div>
		        `;
		        return card;
		    };

		    const renderFavorites = (favorites) => {
		        favoritesList.innerHTML = ''; 
		        if (favorites.length === 0) {
		            emptyMessage.style.display = 'block';
		            return;
		        }
		        emptyMessage.style.display = 'none';
		        favorites.forEach(location => {
		            const card = createFavoriteCard(location);
		            favoritesList.appendChild(card);
		        });
		        attachEventListeners(favorites);
		    };
		    
		    const handleRemoveFavorite = async (targetId, targetType) => {
		        const details = getTargetDetails(targetId, targetType);
                if (!confirm(`คุณต้องการลบ "${details.name}" ออกจากรายการโปรดหรือไม่?`)) return;

		        try {
		            const response = await fetch(`${API_BASE_URL}?targetId=${targetId}&targetType=${targetType}`, {
		                method: 'DELETE',
                        credentials: 'include' 
		            });

		            if (!response.ok) {
		                const errorData = await response.json().catch(() => ({ error: 'Unknown Error' }));
		                throw new Error(errorData.error || 'Failed to delete bookmark');
		            }

		            alert("✅ ลบ Bookmark สำเร็จ");
		            
		            const newFavorites = await fetchUserFavorites();
		            renderFavorites(newFavorites);

		        } catch (error) {
		            console.error("Error removing favorite:", error);
		            alert(`❌ ลบรายการโปรดล้มเหลว: ${error.message}`);
		        }
		    };

		    const attachEventListeners = (favorites) => {
		        document.querySelectorAll('.remove-btn, .card-delete-icon').forEach(btn => {
		            btn.onclick = (event) => {
		                const targetId = event.currentTarget.getAttribute('data-target-id');
		                const targetType = event.currentTarget.getAttribute('data-target-type');
		                handleRemoveFavorite(targetId, targetType);
		            };
		        });

		        document.querySelectorAll('.map-btn').forEach(btn => {
		            btn.onclick = (event) => {
		                const targetName = event.currentTarget.getAttribute('data-name');
		                window.location.href = `map.html?search=${encodeURIComponent(targetName)}`;
		            };
		        });
		    };

		    const initialize = async () => {
		        favoritesList.innerHTML = '';
		        emptyMessage.innerHTML = 'กำลังโหลดรายการโปรด...';
		        emptyMessage.style.display = 'block';

		        const favorites = await fetchUserFavorites();
		        renderFavorites(favorites);
		    };

		    initialize();
		});
	    </script>
	
</body>
</html>