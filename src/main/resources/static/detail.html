<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="detail-title">Details</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
	<link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="../detail-style.css">
</head>
<body>
    <div class="page-container">

        <header class="top-bar">
            <a href="map.html" class="back-link" onclick="history.back(); return false;">
                 <i class="fas fa-arrow-left header-icon"></i>
            </a>
             Detail
        </header>

        <main class="detail-wrapper">
            
            <section class="media-column">
                <div class="image-gallery">
                    <div class="main-image">
                        <img id="location-image" src="" alt="Location Image" class="location-image-display">
                                             <i class="fa-solid fa-image placeholder-icon" id="placeholder-icon"></i>
                    </div>
                </div>
            </section>

            <section class="info-column">
     
                <div class="title-block">
                    <h1 class="item-name" id="location-name">...</h1>
                    <span class="location-pin-icon"><i class="fa-solid fa-location-dot"></i></span>
                    <span class="bookmark-icon" id="bookmark-icon">
                        <i class="fa-regular fa-bookmark"></i> 
                    </span>
                </div>

                <hr class="info-separator">

                <div class="description-block">
                    <h2>เวลาเปิด-ปิดทำการ</h2>
                    <div class="schedule-detail">
                        <p class="schedule-item">จันทร์ - ศุกร์ : <span class="time-slot" id="working-hours-weekday">...</span></p>
                        <p class="schedule-item">เสาร์ - อาทิตย์ : <span class="time-slot closed" id="working-hours-weekend">...</span></p>
                    </div>
  
                    <h2 class="full-description-title">คำอธิบายเพิ่มเติม</h2>
                    <p class="full-description-text" id="full-description-text">...</p>
                </div>
            </section>
        </main>
    </div>

<script src="../map-script.js"></script>

<script>
    const API_BASE_URL = 'http://localhost:8080/api/locations';
    const BOOKMARK_API_URL = 'http://localhost:8080/api/bookmarks'; 
    const TARGET_TYPE = "LOCATION"; 

    let currentTargetId = null; 
    let currentTargetName = null; // 
    let bookmarkIconContainer = null;

    // --- Bookmark UI/State Functions ---
    const setBookmarkIcon = (isBookmarked) => {
        if (!bookmarkIconContainer) return;
        if (isBookmarked) {
            bookmarkIconContainer.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
        } else {
            bookmarkIconContainer.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
        }
    };

    /**
     * ตรวจสอบสถานะ Bookmark เมื่อโหลดหน้า
     * (แก้ไขให้ใช้ credentials: 'include' และเช็คจาก list)
     */
    async function checkInitialBookmarkStatus(targetId) {
        try {
            const response = await fetch(BOOKMARK_API_URL, {
                method: 'GET',
                credentials: 'include' // <-- ✅ FIX: ส่ง cookie
            });

            if (response.status === 403) {
                console.warn("User not logged in, cannot check bookmark status.");
                setBookmarkIcon(false);
                return;
            }
            if (!response.ok) {
                console.error("Failed to check bookmark status:", response.status);
                setBookmarkIcon(false);
                return;
            }
            
            const allBookmarks = await response.json();
            
            // ✅ FIX: ตรวจสอบจาก list ที่ได้มา
            const isBookmarked = allBookmarks.some(
                bookmark => bookmark.targetId == targetId && bookmark.targetType == TARGET_TYPE
            );
            
            setBookmarkIcon(isBookmarked); 
        } catch (error) {
            console.error('Error checking initial bookmark status:', error);
            setBookmarkIcon(false);
        }
    }


    async function fetchAndDisplayDetails() {
        const params = new URLSearchParams(window.location.search);
        const searchTerm = params.get('shortName');
    
        const locationNameElement = document.getElementById('location-name');
        bookmarkIconContainer = document.getElementById('bookmark-icon'); 
        const navButton = document.getElementById('map-navigate-btn');

        if (!searchTerm) {
            locationNameElement.textContent = 'กรุณาระบุสถานที่';
            return;
        }
    
        locationNameElement.textContent = `กำลังโหลดข้อมูลสำหรับ ${searchTerm}...`;

        try {
            const response = await fetch(`${API_BASE_URL}?search=${encodeURIComponent(searchTerm)}`); 

            if (!response.ok) {
                locationNameElement.textContent = `ไม่พบสถานที่ '${searchTerm}' ในระบบ`;
                console.error(`Fetch failed with status: ${response.status}`);
                return;
            }
        
            const locationList = await response.json(); 
        
            if (locationList.length === 0) {
                locationNameElement.textContent = `ไม่พบข้อมูลรายละเอียดสำหรับ ${searchTerm}`;
                return;
            }

            const locationDetails = locationList[0]; 
            
            currentTargetId = locationDetails.id; 
            currentTargetName = locationDetails.name; // 
        
            const workingHours = (locationDetails.openTime && locationDetails.closeTime)
                ? `${locationDetails.openTime} - ${locationDetails.closeTime}`
                : 'N/A';
            
            const descriptionText = locationDetails.description || 'ไม่มีข้อมูลคำอธิบายเพิ่มเติม';

            document.getElementById('detail-title').textContent = `${locationDetails.name} Details`;
            locationNameElement.textContent = locationDetails.name; //

			const locationImage = document.getElementById('location-image');
			const placeholderIcon = document.getElementById('placeholder-icon');
			const imageFilename = locationDetails.imagePath || locationDetails.imageUrl;

			if (imageFilename) {
			    const imageUrl = imageFilename.startsWith('http')
			        ? imageFilename 
			        : `http://localhost:8080/images/${encodeURIComponent(imageFilename)}`; // ✅ FIX: Encode ชื่อไฟล์

			    locationImage.src = imageUrl;
			    locationImage.style.display = 'block';
			    placeholderIcon.style.display = 'none';
                
                // ✅ FIX: เพิ่ม Error handler
                locationImage.onerror = () => {
                    console.warn('Image failed to load:', imageUrl);
                    locationImage.style.display = 'none';
                    placeholderIcon.style.display = 'block';
                };
			} else {
			    locationImage.style.display = 'none';
			    placeholderIcon.style.display = 'block';
			}

            document.getElementById('working-hours-weekday').textContent = workingHours;
            document.getElementById('working-hours-weekend').textContent = "N/A"; // (ตัวอย่าง)

            document.getElementById('full-description-text').textContent = descriptionText;
        
            // 5. ⛔️ [แก้ไข] จัดการ Bookmark Logic
            const token = localStorage.getItem("tu_token"); 
            
            // แสดงปุ่ม Bookmark เสมอ
            bookmarkIconContainer.style.display = 'block';

            if (currentTargetId && token) {
                // ถ้ามี ID สถานที่ และ มี Token (ล็อกอินอยู่) -> ให้ใช้ฟังก์ชัน handleBookmarkClick (ที่เรียก API)
                bookmarkIconContainer.addEventListener('click', handleBookmarkClick);
                checkInitialBookmarkStatus(currentTargetId); 
            } else {
                // ถ้าไม่มี ID หรือ ไม่มี Token (เป็น Guest) -> ให้แสดง Alert
                bookmarkIconContainer.addEventListener('click', () => {
                    alert('กรุณาเข้าสู่ระบบก่อนดำเนินการ');
                });
            }

            // 6. เพิ่ม Event ให้ปุ่มนำทาง
            if (navButton && currentTargetName) {
                navButton.onclick = () => {
                    // กลับไปหน้า map พร้อมส่ง query parameter
                    window.location.href = `/map.html?search=${encodeURIComponent(currentTargetName)}`;
                };
            }
        
        } catch (error) {
            console.error('Error fetching location data for details page:', error);
            locationNameElement.textContent = `เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}`;
        }
    }

    /**
     * จัดการการคลิกไอคอน Bookmark (สำหรับ User ที่ Login แล้ว)
     */
    async function handleBookmarkClick(event) {
        event.preventDefault();

        if (!currentTargetId) {
            alert('ไม่สามารถดำเนินการ Bookmark ได้เนื่องจากไม่พบ ID ของสถานที่');
            return;
        }

        const isCurrentlyBookmarked = bookmarkIconContainer.querySelector('.fa-solid.fa-bookmark');
        
        let method, apiUrl, requestBody = null;

        if (isCurrentlyBookmarked) {
            method = 'DELETE';
            apiUrl = `${BOOKMARK_API_URL}?targetId=${currentTargetId}&targetType=${TARGET_TYPE}`;
        } else {
            method = 'POST';
            apiUrl = BOOKMARK_API_URL;
            requestBody = JSON.stringify({
                targetId: parseInt(currentTargetId),
                targetType: TARGET_TYPE
            });
        }
        
        setBookmarkIcon(!isCurrentlyBookmarked); // Optimistic UI

        try {
            const response = await fetch(apiUrl, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: requestBody,
                credentials: 'include' // <-- ✅ FIX: ส่ง cookie
            });

            // (กรณี 403 หรือ error อื่นๆ)
            if (!response.ok) { 
                 const result = await response.json().catch(() => ({})); 
                 
                 if (response.status === 403) {
                     setBookmarkIcon(isCurrentlyBookmarked); // ย้อนกลับ
                     alert(result.error || 'กรุณาเข้าสู่ระบบก่อนดำเนินการ');
                     // ⛔️ [แก้ไข] ลบบรรทัด redirect ออก
                 } else {
                     setBookmarkIcon(isCurrentlyBookmarked); // ย้อนกลับ
                     alert(`เกิดข้อผิดพลาด: ${result.error || 'Unknown error'}`);
                 }
                 return; // หยุดการทำงาน
            }
            
            // (กรณี Success: 200 OK หรือ 201 Created)
            const result = await response.json();
            const isSuccess = (method === 'POST');
            setBookmarkIcon(isSuccess); 
            
            alert(result.message || (isSuccess ? 'บันทึกสำเร็จ' : 'ยกเลิกสำเร็จ'));

        } catch (error) {
            console.error('Error handling bookmark:', error);
            setBookmarkIcon(isCurrentlyBookmarked); // ย้อนกลับ
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
        }
    }

    document.addEventListener('DOMContentLoaded', fetchAndDisplayDetails);
</script>


    
</body>
</html>