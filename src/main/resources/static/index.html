<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>TU Compass Map</title>
    <meta charset="UTF-8">
    <style>
        #map { height: 90vh; width: 100%; }
        #searchBar { width: 300px; padding: 8px; margin: 10px; }
    </style>
</head>
<body>
    <input id="searchBar" type="text" placeholder="ค้นหาสถานที่ เช่น ยิม7" />
    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXg9TGFh7rvgORmv5d-8rUJS8N1jrjPRE"></script>
    <script>
        let map;
        let markers = [];

        async function loadPlaces(query = "") {
            const url = query ? `/api/places/search?query=${query}` : '/api/places';
            const res = await fetch(url);
            const places = await res.json();

            markers.forEach(m => m.setMap(null));
            markers = [];

            places.forEach(place => {
                const marker = new google.maps.Marker({
                    position: { lat: place.latitude, lng: place.longitude },
                    map,
                    title: place.name
                });
                const info = new google.maps.InfoWindow({
                    content: `<b>${place.name}</b><br>${place.description}<br>เปิด: ${place.openTime} - ${place.closeTime}`
                });
                marker.addListener("click", () => info.open(map, marker));
                markers.push(marker);
            });
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 14.0737, lng: 100.6020 },
                zoom: 16,
            });
            loadPlaces();
        }

        document.addEventListener("DOMContentLoaded", () => {
            initMap();
            const searchBar = document.getElementById("searchBar");
            searchBar.addEventListener("keyup", e => {
                if (e.key === "Enter") loadPlaces(searchBar.value);
            });
        });
    </script>
</body>
</html>